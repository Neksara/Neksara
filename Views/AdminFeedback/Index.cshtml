@model List<AdminFeedbackVM>
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<h3 class="mb-3">Feedback Topik</h3>

<form method="post">

    <!-- ================= TOP ACTION BAR ================= -->
    <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">

        <!-- SEARCH -->
        <input type="text"
               id="searchInput"
               class="form-control"
               style="max-width:260px"
               placeholder="ğŸ” Cari nama / topik / kategori..." />

        <!-- SORT -->
        <select id="sortSelect"
                class="form-select"
                style="max-width:130px">
            <option value="">Sort</option>
            <option value="name_az">A - Z</option>
            <option value="name_za">Z - A</option>
        </select>

        <!-- FILTER RATING -->
        <select id="ratingFilter"
                class="form-select"
                style="max-width:150px">
            <option value="">All Rating</option>
            <option value="5">â˜…â˜…â˜…â˜…â˜…</option>
            <option value="4">â˜…â˜…â˜…â˜…â˜†</option>
            <option value="3">â˜…â˜…â˜…â˜†â˜†</option>
            <option value="2">â˜…â˜…â˜†â˜†â˜†</option>
            <option value="1">â˜…â˜†â˜†â˜†â˜†</option>
        </select>

        <!-- SELECT ALL -->
    <button type="button"
            id="btnSelectAll"
            class="btn btn-outline-primary btn-sm">
        â˜‘ï¸ Select All
    </button>

    <button asp-action="ApproveSelected"
            class="btn btn-success btn-sm"
            onclick="return confirm('Approve testimoni terpilih?')">
        âœ… Approve
    </button>

    <button asp-action="HideSelected"
            class="btn btn-danger btn-sm"
            onclick="return confirm('Hide testimoni terpilih?')">
        ğŸš« Hide
    </button>

    <button asp-action="ShowSelected"
            class="btn btn-primary btn-sm"
            onclick="return confirm('Show testimoni terpilih?')">
        ğŸ‘ Show
    </button>
    </div>

    <!-- ================= TABLE ================= -->
    <table class="table table-bordered table-striped">
        <thead class="text-muted">
            <tr>
                <th style="width:40px"></th>
                <th>Nama</th>
                <th>Pekerjaan</th>
                <th>Topik</th>
                <th>Kategori</th>
                <th>Komentar</th>
                <th>Rating</th>
                <th>Status</th>
            </tr>
        </thead>

        <tbody id="feedbackTable">
        @foreach (var f in Model)
        {
            <tr class="feedback-row"
                data-name="@f.Name"
                data-topic="@f.TopicName"
                data-category="@f.CategoryName"
                data-rating="@f.Rating">

                <td class="text-center">
                    <input type="checkbox"
                           name="selectedIds"
                           value="@f.FeedbackId"
                           class="row-check" />
                </td>

                <td>@f.Name</td>
                <td>@f.Role</td>
                <td>@f.TopicName</td>
                <td>@f.CategoryName</td>
                <td>@f.Description</td>

                <td class="text-warning">
                    @for (int i = 1; i <= 5; i++)
                    {
                        <text>@(i <= f.Rating ? "â˜…" : "â˜†")</text>
                    }
                </td>

            <td>
                @if (f.IsApproved)
                {
                    <span class="badge bg-success">Approved</span>
                }
                else
                {
                    <span class="badge bg-warning">Pending</span>
                }

                @if (!f.IsVisible)
                {
                    <span class="badge bg-danger ms-1">Hidden</span>
                }
            </td>            
            </tr>
        }
        </tbody>
    </table>
</form>

<!-- ================= SCRIPT ================= -->
<script>
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const ratingFilter = document.getElementById('ratingFilter');
    const btnSelectAll = document.getElementById('btnSelectAll');

    const rows = document.querySelectorAll('.feedback-row');
    const checks = document.querySelectorAll('.row-check');
    const table = document.getElementById('feedbackTable');

    let isAllSelected = false;

    // ===== SELECT ALL (BUTTON) =====
    btnSelectAll.addEventListener('click', () => {
        isAllSelected = !isAllSelected;
        checks.forEach(c => c.checked = isAllSelected);

        btnSelectAll.innerHTML = isAllSelected
            ? 'âŒ Unselect All'
            : 'â˜‘ï¸ Select All';
    });

    // ===== FILTER FUNCTION (SEARCH + RATING) =====
    function applyFilter() {
        const keyword = searchInput.value.toLowerCase();
        const rating = ratingFilter.value;

        rows.forEach(row => {
            const name = row.dataset.name.toLowerCase();
            const topic = row.dataset.topic.toLowerCase();
            const category = row.dataset.category.toLowerCase();
            const rowRating = row.dataset.rating;

            const matchText =
                name.includes(keyword) ||
                topic.includes(keyword) ||
                category.includes(keyword);

            const matchRating =
                rating === "" || rowRating === rating;

            row.style.display = (matchText && matchRating) ? "" : "none";
        });
    }

    searchInput.addEventListener('keyup', applyFilter);
    ratingFilter.addEventListener('change', applyFilter);

    // ===== SORT A-Z / Z-A =====
    sortSelect.addEventListener('change', () => {
        const sorted = [...rows].sort((a, b) => {
            const nameA = a.dataset.name.toLowerCase();
            const nameB = b.dataset.name.toLowerCase();

            if (sortSelect.value === 'name_az')
                return nameA.localeCompare(nameB);

            if (sortSelect.value === 'name_za')
                return nameB.localeCompare(nameA);

            return 0;
        });

        table.innerHTML = '';
        sorted.forEach(r => table.appendChild(r));
    });
</script>
