@model Neksara.ViewModels.TopicListVM
@{
    ViewData["Title"] = "Topik E-Learning";
}

<div class="container-fluid content-padding" style="padding-top: 120px;">
    <div class="container">
        <h2 class="fw-bold mb-4">üìò Topik Pembelajaran</h2>

        <!-- ================= FILTER BAR ================= -->
        <div class="row mb-4 align-items-end position-relative" style="z-index: 10;">
            <div class="col-lg-6 col-md-6 mb-2 mb-md-0">
                <input type="text" id="searchInput" class="form-control" placeholder="üîç Cari topik..." />
            </div>
            <div class="col-lg-3 col-md-3">
                <select id="sortSelect" class="form-select">
                    <option value="popular">üî• Terpopuler</option>
                    <option value="rating">‚≠ê Rating Tertinggi</option>
                    <option value="az">A - Z</option>
                    <option value="za">Z - A</option>
                </select>
            </div>
            <div class="col-lg-3 col-md-3">
                <button class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#categoryFilterModal">üè∑ Filter Kategori</button>
            </div>
        </div>

        <!-- ================= CARD GRID ================= -->
        <div class="row g-3" id="topicGrid">
            @if (!Model.Topics.Any())
            {
                <div class="col-12 text-center py-5">
                    <div class="alert alert-light border" role="alert">
                        <i class="bi bi-info-circle fs-1 text-muted mb-3"></i>
                        <h4 class="alert-heading">Topik Kosong</h4>
                        <p>Tidak ada topik dalam kategori ini.</p>
                        <a href="/Learning/CategoryIndex" class="btn btn-outline-primary mt-3">Kembali ke Kategori</a>
                    </div>
                </div>
            }
            else
            {
                @foreach (var t in Model.Topics)
                {
                <div class="col-xl-3 col-lg-3 col-md-4 col-sm-6 topic-item" data-name="@t.TopicName" data-rating="@t.Rating" data-view="@t.ViewCount" data-category="@t.CategoryName">
                    <div class="card h-100 border-0 shadow-sm hover-lift" style="transition: transform 0.2s, box-shadow 0.2s;">
                        <div class="position-relative">
                            <img src="@t.TopicPicture" class="card-img-top rounded-top" alt="@t.TopicName" style="height:140px; object-fit:cover;" />
                            <span class="badge bg-white text-dark position-absolute top-0 start-0 m-2 shadow-sm border" style="font-size: 0.75rem;">@t.CategoryName</span>
                        </div>
                        
                        <div class="card-body p-3 d-flex flex-column">
                            <h6 class="fw-bold text-dark mb-1 text-truncate" title="@t.TopicName" style="font-size: 0.95rem;">@t.TopicName</h6>
                            
                            <div class="mb-2 small" style="font-size: 0.8rem;">
                                <span class="fw-bold text-dark">@t.Rating.ToString("0.0")</span> 
                                <span class="text-warning mx-1">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= Math.Floor(t.Rating)) { <text>‚òÖ</text> }
                                        else { <text>‚òÜ</text> }
                                    }
                                </span>
                                <span class="text-muted">(@t.ReviewCount)</span>
                            </div>

                            <div class="mt-auto d-flex justify-content-between align-items-center small text-muted" style="font-size: 0.75rem;">
                                <span><i class="bi bi-calendar3 me-1"></i>@(t.PublishedAt?.ToString("dd MMM yyyy") ?? "-")</span>
                                <span><i class="bi bi-eye me-1"></i>@t.ViewCount</span>
                            </div>
                        </div>

                        <div class="card-footer bg-white border-0 p-2 text-center">
                            <a href="/Learning/Detail/@t.TopicId" class="btn btn-primary w-100 btn-sm rounded-pill py-1 fw-bold" style="font-size: 0.85rem;">
                                <i class="bi bi-journal-bookmark me-1"></i> Pelajari
                            </a>
                        </div>
                    </div>
                </div>
                }
            }
        </div>
        
        <!-- Client-side No Results (Hidden by default) -->
        <div id="noResults" class="text-center py-5 d-none">
            <div class="alert alert-light border" role="alert">
                <i class="bi bi-search fs-1 text-muted mb-3"></i>
                <h4 class="alert-heading">Topik Tidak Ditemukan</h4>
                <p>Coba kata kunci atau filter lain.</p>
            </div>
        </div>

        <!-- ================= PAGINATION ================= -->
        @if (Model.TotalPages > 1)
        {
            <nav class="mt-5">
                <ul class="pagination justify-content-center">
                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                            <a class="page-link" href="/Learning/Topics?page=@i&categoryId=@Model.CurrentCategory">@i</a>
                        </li>
                    }
                </ul>
            </nav>
        }
    </div>
</div>

<!-- ================= MODAL FILTER ================= -->
<div class="modal fade" id="categoryFilterModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üè∑ Pilih Kategori</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="categoryCheckboxes" class="d-flex flex-column gap-2"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="btnCancelFilter">Cancel</button>
                <button class="btn btn-primary" id="btnApplyFilter">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const items = [...document.querySelectorAll('.topic-item')];
        const grid = document.getElementById('topicGrid');
        const searchInput = document.getElementById('searchInput');
        const sortSelect = document.getElementById('sortSelect');

        const uniqueCategories = [...new Set(items.map(i => i.dataset.category))];
        const categoryBox = document.getElementById('categoryCheckboxes');

        // Ambil CurrentCategory dari server
        const currentCategory = '@(Model.CurrentCategory?.ToString() ?? "")';

        // Generate semua kategori di modal dan cek otomatis jika ada filter
        uniqueCategories.forEach(cat => {
            const isChecked = (cat === currentCategory) ? 'checked' : '';
            const html = `
                <label class="form-check">
                    <input class="form-check-input category-check"
                           type="checkbox"
                           value="${cat}" ${isChecked}>
                    <span class="form-check-label">${cat}</span>
                </label>`;
            if (categoryBox) categoryBox.innerHTML += html;
        });

        // ===== SEARCH =====
        if (searchInput) {
            searchInput.addEventListener('keyup', () => {
                const key = searchInput.value.toLowerCase();
                items.forEach(i => {
                    i.style.display =
                        i.dataset.name.toLowerCase().includes(key) ? 'block' : 'none';
                });
                checkEmpty();
            });
        }

        // ===== SORT =====
        if (sortSelect) {
            sortSelect.addEventListener('change', () => {
                let sorted = [...items];
                if (sortSelect.value === 'rating')
                    sorted.sort((a, b) => b.dataset.rating - a.dataset.rating);
                else if (sortSelect.value === 'az')
                    sorted.sort((a, b) => a.dataset.name.localeCompare(b.dataset.name));
                else if (sortSelect.value === 'za')
                    sorted.sort((a, b) => b.dataset.name.localeCompare(a.dataset.name));
                else
                    sorted.sort((a, b) => b.dataset.view - a.dataset.view);

                grid.innerHTML = '';
                sorted.forEach(i => grid.appendChild(i));
            });
        }

        // ===== CATEGORY FILTER APPLY =====
        const btnApply = document.getElementById('btnApplyFilter');
        if (btnApply) {
            btnApply.onclick = () => {
                const selected = [...document.querySelectorAll('.category-check:checked')]
                    .map(c => c.value);

                items.forEach(i => {
                    i.style.display =
                        selected.length === 0 || selected.includes(i.dataset.category)
                        ? 'block'
                        : 'none';
                });

                checkEmpty();

                bootstrap.Modal.getInstance(
                    document.getElementById('categoryFilterModal')
                ).hide();
            };
        }

        // ===== CATEGORY FILTER CANCEL =====
        const btnCancel = document.getElementById('btnCancelFilter');
        if (btnCancel) {
            btnCancel.onclick = () => {
                // Uncheck semua checkbox
                document.querySelectorAll('.category-check')
                    .forEach(c => c.checked = false);

                // Show semua topik
                items.forEach(i => i.style.display = 'block');
                
                checkEmpty();

                bootstrap.Modal.getInstance(
                    document.getElementById('categoryFilterModal')
                ).hide();
            };
        }

        function checkEmpty() {
            const visibleItems = items.filter(i => i.style.display !== 'none');
            const noResults = document.getElementById('noResults');
            if (noResults) {
                if (visibleItems.length === 0 && items.length > 0) {
                    noResults.classList.remove('d-none');
                } else {
                    noResults.classList.add('d-none');
                }
            }
        }
    });
</script>
