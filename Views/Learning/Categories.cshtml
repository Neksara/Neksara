@model List<Neksara.ViewModels.CategoryCardVM>
@{
    ViewData["Title"] = "Kategori E-Learning";
}

<!-- Search Section -->
<div class="search-section bg-white py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <br>
                <div class="search-wrapper shadow rounded-4 p-4 p-lg-5">
                    <!-- Search Bar -->
                    <div class="input-group input-group-lg mb-4">
                        <span class="input-group-text bg-light border-0 px-4">
                            <i class="bi bi-search text-muted fs-5"></i>
                        </span>
                        <input type="text" 
                               class="form-control border-0 bg-light py-3"
                               id="categorySearch"
                               placeholder="Contoh: Web Development, Data Science, UI/UX Design...">
                        <button class="btn btn-primary px-4" type="button" id="searchButton">
                            <i class="bi bi-search me-2"></i> Cari
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Categories Section -->
<section id="services" class="services section light-background">
    <div class="container">
        <div class="row">
            <!-- Bagian Kiri: Judul Kategori -->
            <div class="col-lg-8">
                <div class="section-header-left" data-aos="fade-up">
                    <h2>Kategori</h2>
                    <p class="lead">Kategori yang paling dimintai oleh karyawan</p>
                </div>
            </div>

            <!-- Bagian Kanan: Filter -->
            <div class="col-lg-4">
                <div class="d-flex justify-content-lg-end mb-4" data-aos="fade-up" data-aos-delay="100">
                    <div id="az-filter" class="dropdown">
                        <button class="btn btn-sm btn-outline-primary dropdown-toggle d-flex align-items-center"
                            type="button" id="azDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-filter-circle me-2"></i>
                            Filter: All
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="azDropdown">
                            <li><a class="dropdown-item az-letter active" href="#" data-letter="all">All</a></li>
                            @for (char c = 'A'; c <= 'Z'; c++)
                            {
                                <li><a class="dropdown-item az-letter" href="#" data-letter="@c">@c</a></li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Kategori Container -->
        <div class="row gy-4" id="categoriesContainer">
            @foreach (var c in Model)
            {
                <div class="col-xl-3 col-md-6 mb-4 category-item" 
                     data-aos="fade-up"
                     data-aos-delay="@(100 + (Model.ToList().IndexOf(c) * 100))" 
                     data-name="@c.CategoryName.ToLower()"
                     data-description="@c.Description?.ToLower()"
                     data-category-letter="@(c.CategoryName.Length > 0 ? c.CategoryName[0].ToString().ToUpper() : "")">
                    
                    <div class="category-card h-100">
                        <!-- Gambar -->
                        <div class="category-img">
                            <img src="@c.CategoryPicture" 
                                 alt="@c.CategoryName" 
                                 class="img-fluid w-100"
                                 style="height:200px; object-fit:cover;">
                        </div>

                        <!-- Judul -->
                        <h4 class="mt-3">
                            <a href="/Learning/Topics?categoryId=@c.CategoryId" class="stretched-link text-decoration-none">
                                @c.CategoryName
                            </a>
                        </h4>

                        <!-- Deskripsi -->
                        <p class="category-desc">
                            @if (string.IsNullOrEmpty(c.Description))
                            {
                                <text>-</text>
                            }
                            else if (c.Description.Length > 100)
                            {
                                @c.Description.Substring(0, 100)
                                @:...
                            }
                            else
                            {
                                @c.Description
                            }
                        </p>

                        <!-- Info Footer -->
                        <div class="category-info mt-auto">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="category-icon">
                                    <i class="bi bi-activity"></i>
                                </div>
                                <div class="category-count">
                                    <span>@c.TotalTopics Topik</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        
        <!-- Pesan jika tidak ditemukan -->
        <div id="noResults" class="row" style="display: none;">
            <div class="col-12 text-center py-5">
                <div class="alert alert-light border" role="alert">
                    <i class="bi bi-search fs-1 text-muted mb-3"></i>
                    <h4 class="alert-heading">Kategori tidak ditemukan</h4>
                    <p>Maaf, tidak ada kategori yang sesuai dengan pencarian Anda. Coba kata kunci lain.</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Inline JavaScript untuk immediate functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const searchInput = document.getElementById('categorySearch');
    const searchButton = document.getElementById('searchButton');
    const categoryItems = document.querySelectorAll('.category-item');
    const noResults = document.getElementById('noResults');
    const azLetters = document.querySelectorAll('.az-letter');
    const azDropdownButton = document.getElementById('azDropdown');
    const categoriesContainer = document.getElementById('categoriesContainer');
    
    console.log('Category search initialized. Found', categoryItems.length, 'items');
    
    // Debug: Log all categories
    categoryItems.forEach((item, index) => {
        const name = item.getAttribute('data-name');
        const letter = item.getAttribute('data-category-letter');
        console.log(`Category ${index + 1}: ${name} (Letter: ${letter})`);
    });
    
    // Fungsi untuk filter kategori
    function filterCategories() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        console.log('Searching for:', searchTerm);
        
        let visibleCount = 0;
        
        categoryItems.forEach((item) => {
            const categoryName = item.getAttribute('data-name') || '';
            const description = item.getAttribute('data-description') || '';
            
            // Cari di nama kategori dan deskripsi
            const match = searchTerm === '' || 
                         categoryName.includes(searchTerm) || 
                         description.includes(searchTerm);
            
            if (match) {
                item.style.display = 'block';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        // Tampilkan/sembunyikan pesan tidak ditemukan
        if (noResults) {
            if (visibleCount === 0 && searchTerm !== '') {
                noResults.style.display = 'block';
                if (categoriesContainer) categoriesContainer.style.display = 'none';
                console.log('No results found for search');
            } else {
                noResults.style.display = 'none';
                if (categoriesContainer) categoriesContainer.style.display = 'flex';
                console.log('Found', visibleCount, 'results for search');
            }
        }
        
        // Refresh AOS animations jika ada
        if (typeof AOS !== 'undefined') {
            setTimeout(() => {
                AOS.refresh();
            }, 100);
        }
    }
    
    // Fungsi untuk filter berdasarkan huruf
    function filterByLetter(letter) {
        console.log('Filtering by letter:', letter);
        
        let visibleCount = 0;
        
        categoryItems.forEach(item => {
            const itemLetter = item.getAttribute('data-category-letter') || '';
            
            if (letter === 'all' || itemLetter === letter) {
                item.style.display = 'block';
                visibleCount++;
                console.log(`Showing: ${item.getAttribute('data-name')} (Letter: ${itemLetter})`);
            } else {
                item.style.display = 'none';
            }
        });
        
        // Tampilkan pesan jika tidak ada hasil
        if (noResults) {
            if (visibleCount === 0 && letter !== 'all') {
                noResults.style.display = 'block';
                if (categoriesContainer) categoriesContainer.style.display = 'none';
                console.log(`No categories found for letter: ${letter}`);
            } else {
                noResults.style.display = 'none';
                if (categoriesContainer) categoriesContainer.style.display = 'flex';
                console.log(`Found ${visibleCount} categories for letter: ${letter}`);
            }
        }
        
        // Clear search input
        if (searchInput) {
            searchInput.value = '';
        }
        
        // Refresh AOS animations jika ada
        if (typeof AOS !== 'undefined') {
            setTimeout(() => {
                AOS.refresh();
            }, 100);
        }
    }
    
    // Event Listeners
    if (searchButton) {
        searchButton.addEventListener('click', filterCategories);
    }
    
    // Enter key pada search input
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                filterCategories();
            }
        });
        
        // Real-time search dengan debounce
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterCategories, 300);
        });
    }
    
    // Filter A-Z
    if (azLetters.length > 0) {
        azLetters.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const letter = this.getAttribute('data-letter');
                console.log('Clicked filter letter:', letter);
                
                // Update tombol dropdown
                if (azDropdownButton) {
                    azDropdownButton.innerHTML = `<i class="bi bi-filter-circle me-2"></i> Filter: ${letter === 'all' ? 'All' : letter}`;
                }
                
                // Update active class
                azLetters.forEach(item => {
                    item.classList.remove('active');
                });
                this.classList.add('active');
                
                // Filter kategori berdasarkan huruf
                filterByLetter(letter);
                
                // Close dropdown jika menggunakan Bootstrap
                if (typeof bootstrap !== 'undefined' && azDropdownButton) {
                    const dropdownInstance = bootstrap.Dropdown.getInstance(azDropdownButton);
                    if (dropdownInstance) {
                        dropdownInstance.hide();
                    }
                }
            });
        });
    }
    
    // Ekspos fungsi ke global scope
    window.filterCategories = filterCategories;
    window.filterByLetter = filterByLetter;
    
    // Debug functions
    window.debugFilter = function() {
        console.log('=== DEBUG FILTER ===');
        console.log('Total items:', categoryItems.length);
        console.log('Active filter:', document.querySelector('.az-letter.active')?.getAttribute('data-letter'));
        
        const letterCounts = {};
        categoryItems.forEach(item => {
            const letter = item.getAttribute('data-category-letter');
            if (letter) {
                letterCounts[letter] = (letterCounts[letter] || 0) + 1;
            }
        });
        console.log('Letter distribution:', letterCounts);
    };
    
    // Test filter N
    window.testFilterN = function() {
        const filterN = document.querySelector('.az-letter[data-letter="N"]');
        if (filterN) {
            filterN.click();
        } else {
            console.log('Filter N not found');
        }
    };
});
</script>